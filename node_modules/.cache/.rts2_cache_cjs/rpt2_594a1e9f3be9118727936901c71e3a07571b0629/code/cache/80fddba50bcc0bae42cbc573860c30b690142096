{"code":"import React, { useEffect, useMemo, useRef } from 'react';\r\nimport { createContext, useContextSelector } from 'use-context-selector';\r\nimport { StoreContext } from '../store/rootReducer';\r\nimport { api } from './consts';\r\nimport { useApi } from './useManualApi';\r\nconst PersistContext = createContext({});\r\nexport const flattenLocations = (locations) => locations.flatMap((c) => c.cities.map((city) => ({\r\n    aliases: city.aliases,\r\n    code: c.code,\r\n    id: city.id,\r\n    name: `${city.name}, ${c.country}`,\r\n    placeType: 'CITY',\r\n    stations: city.stations.map((st) => ({\r\n        ...st,\r\n        aliases: [...st.aliases, ...city.aliases],\r\n        countryCode: c.code,\r\n        name: st.fullname,\r\n        placeType: 'STATION',\r\n        types: st.stationsTypes,\r\n    })),\r\n})));\r\nconst useHandleApiResponse = (response, cacheKey, cacheRef, cache, language) => {\r\n    const data = response.data || cache?.getItem()[cacheKey];\r\n    useEffect(() => {\r\n        if (cache && cacheRef.current !== language && data) {\r\n            cache.setItem({ [cacheKey]: data });\r\n            cacheRef.current = language;\r\n        }\r\n    }, [data, language, cache]);\r\n    return data;\r\n};\r\nconst useHandleApiError = (response, refetch) => {\r\n    useEffect(() => {\r\n        if (!response.error) {\r\n            return;\r\n        }\r\n        const interval = setInterval(refetch, 10_000);\r\n        return () => clearInterval(interval);\r\n    }, [response.error, refetch]);\r\n};\r\nexport const PersistContextProvider = ({ cache, children, }) => {\r\n    const { language, currency } = useContextSelector(StoreContext, (c) => c.state.user);\r\n    const locationsCacheSetForLang = useRef();\r\n    const tariffsCacheSetForLang = useRef();\r\n    const seatClassesCacheSetForLang = useRef();\r\n    const vehicleStandardsCacheSetForLang = useRef();\r\n    useEffect(() => {\r\n        api.defaults.headers.common['X-Lang'] =\r\n            language === 'de-AT' ? 'at' : language;\r\n        api.defaults.headers.common['X-Currency'] = currency;\r\n    }, [language, currency]);\r\n    const [locationsResponse, refetchLocations] = useApi('/consts/locations');\r\n    const [tariffsResponse, refetchTariffs] = useApi('/consts/tariffs');\r\n    const [seatClassesResponse, refetchSeatClasses] = useApi('/consts/seatClasses');\r\n    const [vehicleStandardsResponse, refetchVehicleStandards] = useApi('/consts/vehicleStandards');\r\n    const fetchedForLanguage = useRef(language);\r\n    useEffect(() => {\r\n        if (fetchedForLanguage.current === language) {\r\n            return;\r\n        }\r\n        const abortController = new AbortController();\r\n        const signal = abortController.signal;\r\n        Promise.all([\r\n            refetchLocations({ signal }),\r\n            refetchTariffs({ signal }),\r\n            refetchSeatClasses({ signal }),\r\n            refetchVehicleStandards({ signal }),\r\n        ]).then(() => {\r\n            fetchedForLanguage.current = language;\r\n        });\r\n        return () => {\r\n            abortController.abort();\r\n        };\r\n    }, [\r\n        language,\r\n        refetchLocations,\r\n        refetchSeatClasses,\r\n        refetchTariffs,\r\n        refetchVehicleStandards,\r\n    ]);\r\n    const locations = useMemo(() => {\r\n        if (locationsResponse.data) {\r\n            return flattenLocations(locationsResponse.data);\r\n        }\r\n        return cache?.getItem().locations;\r\n    }, [locationsResponse.data, cache]);\r\n    useEffect(() => {\r\n        if (cache && locationsCacheSetForLang.current !== language && locations) {\r\n            cache.setItem({ locations });\r\n            locationsCacheSetForLang.current = language;\r\n        }\r\n    }, [locations, language, cache]);\r\n    const tariffs = useHandleApiResponse(tariffsResponse, 'tariffs', tariffsCacheSetForLang, cache, language);\r\n    const seatClasses = useHandleApiResponse(seatClassesResponse, 'seatClasses', seatClassesCacheSetForLang, cache, language);\r\n    const vehicleStandards = useHandleApiResponse(vehicleStandardsResponse, 'vehicleStandards', vehicleStandardsCacheSetForLang, cache, language);\r\n    useHandleApiError(locationsResponse, refetchLocations);\r\n    useHandleApiError(tariffsResponse, refetchTariffs);\r\n    useHandleApiError(seatClassesResponse, refetchSeatClasses);\r\n    useHandleApiError(vehicleStandardsResponse, refetchVehicleStandards);\r\n    return (React.createElement(PersistContext.Provider, { value: {\r\n            locations,\r\n            locationsResponse,\r\n            tariffs,\r\n            tariffsResponse,\r\n            seatClassesResponse,\r\n            seatClasses,\r\n            vehicleStandards,\r\n            vehicleStandardsResponse,\r\n        } }, children));\r\n};\r\nexport default PersistContext;\r\n//# sourceMappingURL=PersistContext.js.map","references":["/home/karelpelcak/Documents/repo/rj-shop-bl/node_modules/@types/react/index.d.ts","/home/karelpelcak/Documents/repo/rj-shop-bl/node_modules/axios-hooks/src/index.d.ts","/home/karelpelcak/Documents/repo/rj-shop-bl/node_modules/use-context-selector/dist/src/index.d.ts","/home/karelpelcak/Documents/repo/rj-shop-bl/src/store/rootReducer.tsx","/home/karelpelcak/Documents/repo/rj-shop-bl/src/hooks/consts.ts","/home/karelpelcak/Documents/repo/rj-shop-bl/src/hooks/types.ts","/home/karelpelcak/Documents/repo/rj-shop-bl/src/hooks/useLocations.ts","/home/karelpelcak/Documents/repo/rj-shop-bl/src/hooks/useManualApi.ts","/home/karelpelcak/Documents/repo/rj-shop-bl/src/hooks/useSeatClasses.ts","/home/karelpelcak/Documents/repo/rj-shop-bl/src/hooks/useTariffs.ts","/home/karelpelcak/Documents/repo/rj-shop-bl/src/hooks/useVehicleStandards.ts"],"map":"{\"version\":3,\"file\":\"PersistContext.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../src/hooks/PersistContext.tsx\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/home/karelpelcak/Documents/repo/rj-shop-bl/dist/hooks/PersistContext.d.ts","writeByteOrderMark":false,"text":"import React, { ReactNode } from 'react';\r\nimport type { ResponseValues } from 'axios-hooks';\r\nimport { ConnectionSearchCity, LocationCountry } from './useLocations';\r\nimport type { SeatClassData } from './useSeatClasses';\r\nimport type { TariffResponse } from './useTariffs';\r\nimport type { VehicleStandard } from './useVehicleStandards';\r\ninterface PersistProps extends PersistContextCacheItem {\r\n    locationsResponse: ResponseValues<LocationCountry[], any, any>;\r\n    tariffsResponse: ResponseValues<TariffResponse[], any, any>;\r\n    seatClassesResponse: ResponseValues<SeatClassData[], any, any>;\r\n    vehicleStandardsResponse: ResponseValues<VehicleStandard[], any, any>;\r\n}\r\nexport interface PersistContextCacheItem {\r\n    locations?: ConnectionSearchCity[];\r\n    tariffs?: TariffResponse[];\r\n    seatClasses?: SeatClassData[];\r\n    vehicleStandards?: VehicleStandard[];\r\n}\r\nexport interface PersistContextCache {\r\n    getItem: () => PersistContextCacheItem;\r\n    setItem: (o: Partial<PersistContextCacheItem>) => void;\r\n}\r\ndeclare const PersistContext: import(\"use-context-selector\").Context<PersistProps>;\r\ninterface Props {\r\n    children?: ReactNode;\r\n    cache?: PersistContextCache;\r\n}\r\nexport declare const flattenLocations: (locations: LocationCountry[]) => ConnectionSearchCity[];\r\nexport declare const PersistContextProvider: React.FC<Props>;\r\nexport default PersistContext;\r\n"}}
