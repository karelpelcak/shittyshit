import e,{useEffect as t,useMemo as a,useState as r,useRef as n,useCallback as o}from"react";import{createContext as s,useContextSelector as i,useContext as l}from"use-context-selector";import{useImmerReducer as c,useImmer as d}from"use-immer";import u,{AxiosError as p,isAxiosError as g}from"axios";import m from"jssha";import f from"qs";import h from"fast-deep-equal";import y from"fast-deep-equal/es6/react";import{makeUseAxios as T}from"axios-hooks";import S from"fuse.js";import E from"lodash.deburr";function R(){return R=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)({}).hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},R.apply(null,arguments)}function v(e,t){if(null==e)return{};var a={};for(var r in e)if({}.hasOwnProperty.call(e,r)){if(t.includes(r))continue;a[r]=e[r]}return a}var A,k,C,_,I;!function(e){e.Regular="REGULAR",e.CzechStudentPass15="CZECH_STUDENT_PASS_15",e.CzechStudentPass26="CZECH_STUDENT_PASS_26",e.Isic="ISIC",e.AttendedChild="ATTENDED_CHILD",e.Disabled="DISABLED",e.DisabledAttendance="DISABLED_ATTENDANCE",e.Euro26="EURO26",e.Child="CHILD",e.UaRefugee="UA_REFUGEE",e.UaRefugeeChild="UA_REFUGEE_CHILD",e.Disabled3="DISABLED_3",e.ChildUnder12="CHILD_UNDER_12"}(A||(A={})),function(e){e.C0="C0",e.C1="C1",e.C2="C2",e.No="NO",e.Train1StClass="TRAIN_1ST_CLASS",e.Train2NdClass="TRAIN_2ND_CLASS",e.TrainCouchetteBusiness4="TRAIN_COUCHETTE_BUSINESS_4",e.TrainCouchetteBusiness="TRAIN_COUCHETTE_BUSINESS",e.TrainCouchetteRelax="TRAIN_COUCHETTE_RELAX",e.TrainCouchetteRelaxForWomen="TRAIN_COUCHETTE_RELAX_FOR_WOMEN",e.TrainCouchetteStandard="TRAIN_COUCHETTE_STANDARD",e.TrainLowCost="TRAIN_LOW_COST",e.TrainStandardPlus="TRAIN_STANDARD_PLUS",e.BusStandard="BUS_STANDARD",e.BusRelax="BUS_RELAX"}(k||(k={})),function(e){e.Cash="CASH",e.Gift="GIFT",e.Online="ONLINE",e.Credit="CREDIT",e.FastBank="FAST_BANK",e.Transfer="TRANSFER"}(C||(C={})),function(e){e.YELLOW="YELLOW",e.YELLOW_R8="YELLOW_R8",e.ECONOMY="ECONOMY",e.FUN_RELAX="FUN_RELAX",e.FUN_RELAX_SELF_SERVICE="FUN_RELAX_SELF_SERVICE",e.FUN_RELAX_NO_STEWARD="FUN_RELAX_NO_STEWARD",e.DEUTSCHE_BAHN="DEUTSCHE_BAHN",e.ECONOMY_PLATFORM="ECONOMY_PLATFORM",e.SAD="SAD",e.WEST_BAHN="WEST_BAHN",e.IDS_JMK="IDS_JMK",e.OBB="OBB",e.UKRAINIAN_RAILWAYS="UKRAINIAN_RAILWAYS",e.GEPARD_EXPRESS="GEPARD_EXPRESS",e.UNITED_BUSES="UNITED_BUSES"}(_||(_={})),function(e){e.Account="ACCOUNT",e.Cash="CASH",e.Giftcertificate="GIFT_CERTIFICATE",e.Gopaysporopay="GOPAY_SPOROPAY",e.Gopaytatrapay="GOPAY_TATRAPAY",e.Gopayunicreditsk="GOPAY_UNICREDIT_SK",e.Gopayvub="GOPAY_VUB",e.Gpeapplepay="GPE_APPLE_PAY",e.Gpegooglepay="GPE_GOOGLE_PAY",e.Gpeonlinecard="GPE_ONLINE_CARD",e.Payuapplepay="PAYU_APPLE_PAY",e.Payucsasservis24="PAYU_CSAS_SERVIS24",e.Payucsob="PAYU_CSOB",e.Payuera="PAYU_ERA",e.Payufio="PAYU_FIO",e.Payugemoneybank="PAYU_GE_MONEY_BANK",e.Payugiropay="PAYU_GIROPAY",e.Payugooglepay="PAYU_GOOGLE_PAY",e.Payuinstanttr="PAYU_INSTANT_TR",e.Payukb="PAYU_KB",e.Payumbankmpenize="PAYU_MBANK_MPENIZE",e.Payuonlinecard="PAYU_ONLINE_CARD",e.Payuraiffeisen="PAYU_RAIFFEISEN",e.Payusepa="PAYU_SEPA",e.Payusofort="PAYU_SOFORT",e.Payusofortat="PAYU_SOFORT_AT",e.Payuunicredit="PAYU_UNICREDIT",e.Transfer="TRANSFER"}(I||(I={}));var b,O={__proto__:null,get Tariff(){return A},get SeatClass(){return k},get PaymentType(){return C},get VehicleKey(){return _},get PaymentMethod(){return I}};!function(e){e.PROD="prod",e.QA="qa",e.DEV="dev"}(b||(b={}));const P=Object.freeze({[b.PROD]:"https://brn-ybus-pubapi.sa.cz/restapi",[b.QA]:"https://brn-qa-ybus-pubapi.sa.cz/restapi",[b.DEV]:"https://brn-dev-ybus-pubapi.sa.cz/restapi"}),N={serialize:e=>f.stringify(e,{indices:!1})},D=u.create({baseURL:P[b.QA],timeout:3e4,headers:{"Cache-Control":"no-cache"},paramsSerializer:N,transitional:{clarifyTimeoutError:!0}}),w=e=>D.interceptors.response.use(e=>(delete D.defaults.headers.common["X-ReCaptcha-Token"],e),async t=>{var a;if(!u.isCancel(t))return 401===(null==t||null==(a=t.response)?void 0:a.status)&&e(),Promise.reject(t)}),L=["/tickets/create/unregistered","/users/login/registeredAccount","/users/login/unregisteredAccount","/users/login/email","/users/signup/registeredAccount","/users/forgottenPassword/email","/tickets/timetickets/unregistered"],U=(e,t)=>{const a=new m("SHA3-512","TEXT"),r="string"==typeof e?e:JSON.stringify(e);return a.setHMACKey(t,"TEXT"),a.update(r),a.getHMAC("HEX")},M=e=>D.interceptors.request.use(t=>{var a,r;const n=null==(a=t.headers)||null==(a=a.Authorization)?void 0:a.split(" ")[1],o=t.hideTokenHash;return t.headers||(t.headers={}),null!=(r=t.url)&&r.includes("const")||o||(n&&!L.includes(t.url||"")?t.headers["X-Token-Hash"]=U(n,e):t.data&&(t.headers["X-Body-Hash"]=U(t.data,e))),o&&delete t.hideTokenHash,t.headers.Referer="regiojet:///",t}),J="alert.outage",F="alert.fail",B="alert.network",$=e=>{if(e){switch(e.code){case p.ERR_CANCELED:return;case p.ETIMEDOUT:case p.ECONNABORTED:return J;case p.ERR_NETWORK:case"ENOTFOUND":return B}return F}},G=Object.freeze({cs:["CZ","SK"],de:["DE","AT","CZ"],"de-AT":["AT","DE","CZ"],en:["UK","BE","NL","LU","DE"],hu:["HU","SK","AT"],pl:["PL","CZ","SK","UA"],sk:["SK","CZ","AT"],uk:["UA","CZ","PL","SK","HU"]}),x=[I.Cash,I.Transfer,I.Giftcertificate];var Y={__proto__:null,get Env(){return b},envUrls:P,paramsSerializer:N,api:D,resInterceptor:w,getHashedData:U,reqInterceptor:M,TIMEOUT_MESSAGE:J,FAIL_MESSAGE:F,NETWORK_MESSAGE:B,getErrorMessage:$,langPriorityCountries:G,unusablePaymentMethods:x};const H=e=>Object.entries(e).reduce((e,[t,a])=>a.length?(e.push(...a.map(({id:e,sroTicketId:a})=>({id:e||a,type:t}))),e):e,[]),X=()=>{let e="",t="",a=(new Date).valueOf();for(;a>1;){const t=Math.floor(a%58);a/=58,e+="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"[t]}for(let a=e.length;a<8;a++)t+="1";return t+e},j=Object.freeze({EMAIL:"email",FIRST_NAME:"firstName",SURNAME:"surname"}),K=["TRAIN_COUCHETTE_BUSINESS_4","TRAIN_COUCHETTE_BUSINESS"],z=(e,t)=>{const a=t.findIndex(t=>t.seatClassKey===e),r=t[a],n=t[a+1];return!r||!n||"RJ_SEAT"!==r.type||"RJ_SEAT"!==n.type||r.price>=n.price||n.price/r.price>1.5||r.seatClassKey===n.seatClassKey||r.actionPrice||n.actionPrice||K.includes(n.seatClassKey)?null:n},W=e=>{var t;"undefined"!=typeof window&&null!=(t=window.dataLayer)&&t.push&&"SET_RESPONSE_STATE"!==e.event&&window.dataLayer.push(e)},q=()=>{const e="undefined"!=typeof localStorage?localStorage.getItem("affiliateCode"):"";if(e)return parseInt(localStorage.getItem("affiliateCodeExpiration")||"",10)<(new Date).valueOf()?(localStorage.removeItem("affiliateCode"),void localStorage.removeItem("affiliateCodeExpiration")):e},V=[4987881e3,3088864001,4961583e3,5009212e3,4961583001,2370298003,372825006,5095524133,5095524027,372825007,372825008,4961583004,7063331002],Q=[5010256458,5812866010,5145776001,5010257320,5812866008,5812866007,5812866006,5812866005,5812866004,5812866003,5812866002,5812866001,3088864e3,5812866009],Z=(e,t)=>V.includes(e)&&V.includes(t)||Q.includes(e)&&Q.includes(t),ee=(e,t)=>y(e,t)?[]:t.filter(t=>!e.some(e=>y(e,t))),te=(e,t)=>e.includes(t)?e.indexOf(t):e.length;var ae={__proto__:null,basketItemsToTicketTypes:H,createTxToken:X,mapFieldToUser:j,couchetteClasses:K,getMoreExpensiveClass:z,gtmPush:W,getAffiliateCode:q,mapFromToSections:e=>e.map(e=>({sectionId:e.id,fromStationId:e.departureStationId,toStationId:e.arrivalStationId})),r8Stations:V,r23Stations:Q,isRegional:Z,getNewSeats:ee,getAddonTranslationKey:(e,t)=>{const a=e.toLowerCase();return a.includes("kolo")?"addon.bike":a.includes("lyze")?"addon.ski":a.includes("parkovani")?"addon.parking":a.includes("zavazadlo")?"addon.luggage":a.includes("smartguide")?"addon.smartguide":a.includes("berider")?"addon.berider":a.includes("hoppygo")?"addon.hoppygo":t?"addon."+e:e},unorderedArrayEqual:(e,t)=>{if(!e||!t)return!1;const a=e.sort(),r=t.sort();return a.every((e,t)=>r[t]===e)},calculateDistance:(e,t,a,r)=>{const n=.017453292519943295,o=.5-Math.cos((a-e)*n)/2+Math.cos(e*n)*Math.cos(a*n)*(1-Math.cos((r-t)*n))/2;return 12742*Math.asin(Math.sqrt(o))},getPriorityInArray:te};const re="CLEAR_BOOKING",ne="REPLACE_TARIFFS",oe="SAVE_CONNECTION",se="SELECT_ADDONS",ie="SELECT_CLASS",le="SELECT_CODE_DISCOUNT",ce="SELECT_PERC_DISCOUNT",de="SELECT_ROUTE",ue="SELECT_SEATS",pe="SET_PRICE",ge="UPSELL_ADDONS",me=["direction"],fe=["direction"],he=["direction"],ye=["direction"],Te={booking:null,fav:[]},Se=s({}),Ee=(e,t)=>{var a;switch("undefined"!=typeof window&&W({event:t.type+((null==t||null==(a=t.payload)?void 0:a.direction)||""),[t.type]:R({},t.payload,{currency:D.defaults.headers.common["X-Currency"]})}),t.type){case ne:var r;null!=e&&null!=(r=e.booking)&&null!=(r=r[t.payload.direction])&&r.tariffs&&(e.booking[t.payload.direction].tariffs=t.payload.tariffs);break;case oe:if(e.booking={connection:t.payload,isReturn:!!t.payload.returnDepartureDate,there:null,back:null},!t.payload.ignoreFavorite&&t.payload.fromLocationId&&t.payload.fromLocationType&&t.payload.toLocationId&&t.payload.toLocationType){const a=e.fav.findIndex(e=>e.fromLocationId===t.payload.fromLocationId&&e.toLocationId===t.payload.toLocationId);-1!==a&&e.fav.splice(a,1),e.fav.unshift({fromLocationId:t.payload.fromLocationId,fromLocationType:t.payload.fromLocationType,toLocationId:t.payload.toLocationId,toLocationType:t.payload.toLocationType})}break;case de:{const a=t.payload,{direction:r}=a,n=v(a,me);if(e.booking){const t=R({},n,{bookingState:"ROUTE_SELECTED",seatClass:void 0,sections:void 0,price:void 0,priceSource:void 0,selectedAddons:void 0,passengers:void 0});h(t,e.booking[r])||(e.booking[r]=t)}break}case ge:{const a=t.payload,{direction:r}=a,o=v(a,fe);if(e.booking){var n;const t=R({},null==(n=e.booking)?void 0:n[r],o,{bookingState:e.booking[r].bookingState});h(t,e.booking[r])||(e.booking[r]=t)}break}case ie:{const a=t.payload,{direction:r}=a,n=v(a,he);if(e.booking){var o;const t=R({},(null==(o=e.booking)?void 0:o[r])||{},n,{bookingState:"CLASS_SELECTED",passengers:void 0});h(t,e.booking[r])||(e.booking[r]=t)}break}case ue:{const{direction:a,seats:r}=t.payload;if(e.booking){var s,i;const t=R({},null==(s=e.booking)?void 0:s[a],{sections:null==(i=e.booking)||null==(i=i[a])||null==(i=i.sections)?void 0:i.map(e=>R({},e,{selectedSeats:r.filter(t=>t.sectionId===e.sectionId)})),bookingState:"SEAT_SELECTED"});h(t,e.booking[a])||(e.booking[a]=t)}break}case se:{const a=t.payload,{direction:r}=a,n=v(a,ye);if(e.booking){var l;const t=R({},null==(l=e.booking)?void 0:l[r],n,{bookingState:"ADDONS_SELECTED"});h(t,e.booking[r])||(e.booking[r]=t)}break}case ce:{var c;const{direction:a,percentualDiscountIds:r,discountAmount:n}=t.payload;if(null!=(c=e.booking)&&null!=(c=c[a])&&c.bookingState){var d;const t=R({},null==(d=e.booking)?void 0:d[a],{percentualDiscountIds:r,discountAmount:n,bookingState:e.booking[a].bookingState});h(t,e.booking[a])||(e.booking[a]=t)}break}case le:{var u;const{direction:a,codeDiscount:r,discountAmount:n}=t.payload;var p;null!=(u=e.booking)&&null!=(u=u[a])&&u.bookingState&&(e.booking[a]=R({},(null==(p=e.booking)?void 0:p[a])||{},{codeDiscount:r,discountAmount:n,bookingState:e.booking[a].bookingState}));break}case pe:{var g;const{direction:a,price:r}=t.payload;if(null!=(g=e.booking)&&g[a]){var m;const t=R({},(null==(m=e.booking)?void 0:m[a])||{},{price:r,bookingState:e.booking[a].bookingState});h(t,e.booking[a])||(e.booking[a]=t)}break}case re:var f,y;if(null!=t&&null!=(f=t.payload)&&f.direction||!e.booking){if(null!=t&&null!=(y=t.payload)&&y.direction&&e.booking){var T;"there"===t.payload.direction&&(e.booking.there=e.booking.back),null!=(T=e.booking)&&T.there?(e.booking.back||e.booking.isReturn)&&(e.booking.back=null,e.booking.isReturn=!1):e.booking=null}}else e.booking=null}},Re=({children:r,persistConfig:n,persist:o})=>{const[s,i]=c(Ee,o&&(null==n?void 0:n.getItem().bookings)||Te);t(()=>{o&&(null==n||n.setItem({bookings:s}))},[s]),t(()=>{const e=w(()=>{i({type:"CLEAR_BOOKING",payload:{}})});return()=>{D.interceptors.response.eject(e)}},[]);const l=a(()=>({dispatch:i,state:s}),[i,s]);return e.createElement(Se.Provider,{value:l},r)};var ve;!function(e){e[e.addons=0]="addons",e[e.connection=1]="connection",e[e.connectionRoute=2]="connectionRoute",e[e.createTickets=3]="createTickets",e[e.credit=4]="credit",e[e.locations=5]="locations",e[e.passengersData=6]="passengersData",e[e.payment=7]="payment",e[e.seats=8]="seats",e[e.tariffs=9]="tariffs",e[e.ticket=10]="ticket",e[e.ticketAction=11]="ticketAction",e[e.user=12]="user",e[e.userTickets=13]="userTickets",e[e.useTicketsType=14]="useTicketsType",e[e.ticketReview=15]="ticketReview",e[e.seatClasses=16]="seatClasses",e[e.vehicleStandards=17]="vehicleStandards"}(ve||(ve={}));const Ae={[ve.addons]:{loading:!1},[ve.connection]:{loading:!1},[ve.connectionRoute]:{loading:!1},[ve.createTickets]:{loading:!1},[ve.credit]:{loading:!1},[ve.locations]:{loading:!0},[ve.passengersData]:{loading:!1},[ve.payment]:{loading:!1},[ve.seats]:{loading:!1},[ve.ticket]:{loading:!1},[ve.tariffs]:{loading:!0},[ve.ticketAction]:{loading:!1},[ve.userTickets]:{loading:!1},[ve.useTicketsType]:{loading:!1},[ve.user]:{loading:!1},[ve.ticketReview]:{loading:!1},[ve.vehicleStandards]:{loading:!1},[ve.seatClasses]:{loading:!1}},ke=s({}),Ce=(e,t)=>{switch(t.type){case"SET_RESPONSE_STATE":{const{error:a,loading:r,type:n}=t.payload;if(void 0!==n){const t={error:a,loading:r};h(e[n],t)||(e[n]=t)}else Object.keys(e).forEach(t=>{const n={error:a,loading:r};h(e[+t],n)||(e[+t]=n)});break}}},_e=({children:r,persistConfig:n,persist:o})=>{const[s,i]=c(Ce,o&&(null==n?void 0:n.getItem().responseState)||Ae);t(()=>{o&&(null==n||n.setItem({responseState:s}))},[s]);const l=a(()=>({dispatch:i,state:s}),[i,s]);return e.createElement(ke.Provider,{value:l},r)},Ie={cooldownTs:0,displayCount:0},be=(e,t)=>{switch(t.type){case"REFUSE_UPSELL":e.displayCount++,2===e.displayCount&&(e.cooldownTs=(new Date).valueOf()+12096e5);break;case"REFRESH_COOLDOWN":e.cooldownTs&&(new Date).valueOf()>e.cooldownTs&&(e.cooldownTs=0,e.displayCount=0)}},Oe=(e,t)=>{switch(t.type){case"CLEAR_USER":e.user=null,e.token=null;break;case"SET_LANG":t.payload.language&&(e.language=t.payload.language);break;case"SET_TOKEN":e.token=t.payload.token;break;case"SET_USER":e.user=t.payload.user;break;case"SET_CURRENCY":D.defaults.headers.common["X-Currency"]=t.payload.currency,e.currency=t.payload.currency;break;case"SET_PAYMENT_CODE":e.paymentMethodCode=t.payload.paymentMethodCode;break;case"SET_LOGIN_NR":e.loginNrs=Array.from(new Set([t.payload.loginNr,...e.loginNrs||[]])).slice(0,6)}},Pe=s({dispatch:{upsellDispatch:()=>{},userDispatch:()=>{}},interceptorsMounted:!1,state:{upsell:Ie,user:{loginNrs:[],user:null,token:null,currency:"CZK",language:"cs",paymentMethodCode:null}}}),Ne=({children:a,currency:n,transportHash:o,lang:s="cs",persistConfig:i,persist:l})=>{const[d,u]=c(be,(null==i?void 0:i.getItem().upsell)||Ie),[p,g]=c(Oe,(null==i?void 0:i.getItem().user)||((e,t="cs")=>({loginNrs:[],user:null,token:null,currency:e,language:t,paymentMethodCode:null}))(n,s)),[m,f]=r(!1);return t(()=>{null==i||i.setItem({upsell:d})},[d]),t(()=>{null==i||i.setItem({user:p})},[p]),t(()=>{p.token?D.defaults.headers.Authorization=`Bearer ${p.token}`:delete D.defaults.headers.Authorization},[p.token]),t(()=>{p.currency&&(D.defaults.headers.common["X-Currency"]=p.currency)},[p.currency]),t(()=>{const e=o?M(o):void 0,t=w(()=>{g({type:"CLEAR_USER"})});return f(!0),()=>{e&&D.interceptors.request.eject(e),D.interceptors.response.eject(t)}},[]),e.createElement(Pe.Provider,{value:{dispatch:{upsellDispatch:u,userDispatch:g},interceptorsMounted:m,state:{upsell:d,user:p}}},e.createElement(_e,{persistConfig:i,persist:null==l?void 0:l.responseState},e.createElement(Re,{persistConfig:i,persist:null==l?void 0:l.booking},a)))},De=T({axios:D}),we=T({axios:D,defaultOptions:{manual:!0}}),Le=s({}),Ue=(e,a,r,n,o)=>{const s=e.data||(null==n?void 0:n.getItem()[a]);return t(()=>{n&&r.current!==o&&s&&(n.setItem({[a]:s}),r.current=o)},[s,o,n]),s},Me=(e,a)=>{t(()=>{if(!e.error)return;const t=setInterval(a,1e4);return()=>clearInterval(t)},[e.error,a])},Je=({cache:r,children:o})=>{const{language:s,currency:l}=i(Pe,e=>e.state.user),c=n(),d=n(),u=n(),p=n();t(()=>{D.defaults.headers.common["X-Lang"]="de-AT"===s?"at":s,D.defaults.headers.common["X-Currency"]=l},[s,l]);const[g,m]=De("/consts/locations"),[f,h]=De("/consts/tariffs"),[y,T]=De("/consts/seatClasses"),[S,E]=De("/consts/vehicleStandards"),v=n(s);t(()=>{if(v.current===s)return;const e=new AbortController,t=e.signal;return Promise.all([m({signal:t}),h({signal:t}),T({signal:t}),E({signal:t})]).then(()=>{v.current=s}),()=>{e.abort()}},[s,m,T,h,E]);const A=a(()=>g.data?(e=>e.flatMap(e=>e.cities.map(t=>({aliases:t.aliases,code:e.code,id:t.id,name:`${t.name}, ${e.country}`,placeType:"CITY",stations:t.stations.map(a=>R({},a,{aliases:[...a.aliases,...t.aliases],countryCode:e.code,name:a.fullname,placeType:"STATION",types:a.stationsTypes}))}))))(g.data):null==r?void 0:r.getItem().locations,[g.data,r]);t(()=>{r&&c.current!==s&&A&&(r.setItem({locations:A}),c.current=s)},[A,s,r]);const k=Ue(f,"tariffs",d,r,s),C=Ue(y,"seatClasses",u,r,s),_=Ue(S,"vehicleStandards",p,r,s);return Me(g,m),Me(f,h),Me(y,T),Me(S,E),e.createElement(Le.Provider,{value:{locations:A,locationsResponse:g,tariffs:k,tariffsResponse:f,seatClassesResponse:y,seatClasses:C,vehicleStandards:_,vehicleStandardsResponse:S}},o)},Fe=["children","env","verbose","cache","applicationOrigin"],Be=a=>{let{children:r,env:n=b.QA,verbose:o,cache:s,applicationOrigin:i="WEB"}=a,l=v(a,Fe);return D.defaults.baseURL=P[n],D.defaults.headers["X-Application-Origin"]=i,t(()=>{if(o){const e=D.interceptors.request.use(e=>{const{baseURL:t,data:a,headers:r,params:n,url:o}=e;return console.log("Req: ",{baseURL:t,data:a,headers:r,params:n,url:o}),e}),t=D.interceptors.response.use(e=>{var t;const{baseURL:a,params:r,url:n}=null!=(t=e.request)?t:{},{status:o,data:s,headers:i}=e;return console.log("Res: ",{baseURL:a,data:s,headers:i,params:r,status:o,url:n}),e},e=>{throw console.log("Res error: ",e,JSON.stringify(e,null,2)),e});return()=>{D.interceptors.request.eject(e),D.interceptors.response.eject(t)}}},[o]),e.createElement(Ne,R({},l),e.createElement(Je,{cache:s},r))},$e=e=>{const t=i(ke,e=>e.dispatch);return(a,r,n=void 0)=>{t({type:"SET_RESPONSE_STATE",payload:{type:e,error:{message:a,errorFields:n},loading:r}})}},Ge=()=>{const e=$e(ve.addons),a=i(ke,e=>e.state[ve.addons]),[{loading:r,error:n,data:o},s]=we({url:"/addons",method:"POST"}),[{loading:l,error:c},d]=we({url:"/addons/verify",method:"POST"}),[{loading:u,error:p},g]=we({url:"/addons",method:"PUT"});return t(()=>{var t,a,o,s,i,d;e((null==n||null==(t=n.response)||null==(t=t.data)?void 0:t.message)||(null==c||null==(a=c.response)||null==(a=a.data)?void 0:a.message)||(null==p||null==(o=p.response)||null==(o=o.data)?void 0:o.message),r||l||u,(null==n||null==(s=n.response)||null==(s=s.data)?void 0:s.errorFields)||(null==c||null==(i=c.response)||null==(i=i.data)?void 0:i.errorFields)||(null==p||null==(d=p.response)||null==(d=d.data)?void 0:d.errorFields))},[n,r,c,l,p,u]),R({fetchAddons:async(e,t)=>{try{return await s({data:e,signal:t}),!0}catch(e){return!1}},putAddons:async(e,t,a)=>{try{return await g({data:{selectedAddons:t},params:{ticketId:e},signal:a}),!0}catch(e){return!1}},verifyAddons:async(e,t)=>{try{return await d({data:e,signal:t}),!0}catch(e){return!1}},data:null==o?void 0:o.filter(e=>e.maxCount).sort((e,t)=>t.price-e.price)},a)},xe=["selectedSeats"],Ye=(e="there")=>{const t=i(Se,e=>{var t;return null==(t=e.state.booking)?void 0:t.isReturn}),a="back"===e&&t?"back":"there",r=i(Se,e=>{var t;return null==(t=e.state.booking)?void 0:t[a]}),n=i(Se,e=>e.dispatch),[{error:o,data:s},l]=we({method:"POST"});return{data:s,error:o,selectCodeDiscount:async(e,t)=>{var o,s;if(!r)return;const{data:i}=await l({url:"number"==typeof e?`/discounts/percentual/${e}/verify`:`/discounts/code/${e}/verify`,data:{actionPrice:null,passengers:null==(o=r.tariffs)?void 0:o.map(e=>({tariff:e})),route:{priceSource:r.priceSource,routeId:r.routeId,seatClass:r.seatClass,sections:null==(s=r.sections)?void 0:s.map(e=>{let{selectedSeats:t}=e;return{section:v(e,xe),selectedSeats:t}})},ticketPrice:r.price},signal:t}),c=r.price-i.discountedTicketPrice;n({type:pe,payload:{direction:a,price:i.discountedTicketPrice}}),n("number"==typeof e?{type:ce,payload:{percentualDiscountIds:[e],discountAmount:c,direction:a}}:{type:le,payload:{codeDiscount:e,discountAmount:c,direction:a}})}}},He=(e="there")=>{const t=i(Se,e=>{var t;return null==(t=e.state.booking)?void 0:t.isReturn}),a="back"===e&&t?"back":"there",r=i(Se,e=>e.dispatch);return{clearBooking:e=>r({type:re,payload:{direction:e}}),createBooking:e=>r({type:oe,payload:e}),replaceTariffs:e=>r({type:ne,payload:{direction:a,tariffs:e}}),selectAddons:e=>r({type:se,payload:{selectedAddons:e,direction:a}}),selectClass:e=>r({type:ie,payload:R({},e,{direction:a})}),selectRoute:e=>r({type:de,payload:R({},e,{direction:a})}),selectSeats:e=>r({type:ue,payload:{seats:e,direction:a}}),upsellAddons:e=>r({type:ge,payload:{selectedAddons:e,direction:a}})}},Xe=()=>{const e=i(Se,e=>{var t;return null==(t=e.state.booking)||null==(t=t.there)?void 0:t.selectedAddons}),t=i(Se,e=>{var t;return null==(t=e.state.booking)||null==(t=t.back)?void 0:t.selectedAddons}),r=i(Se,e=>{var t;return null==(t=e.state.booking)||null==(t=t.there)?void 0:t.price}),n=i(Se,e=>{var t;return null==(t=e.state.booking)||null==(t=t.back)?void 0:t.price}),o=i(Se,e=>{var t;return null==(t=e.state.booking)||null==(t=t.there)||null==(t=t.carbonOffset)?void 0:t.amount}),s=i(Se,e=>{var t;return null==(t=e.state.booking)||null==(t=t.there)||null==(t=t.carbonOffset)?void 0:t.amount});console.log("ðŸš€ ~ useBookingPrice ~ backCarbonOffsetPrice:",o),console.log("ðŸš€ ~ useBookingPrice ~ thereCarbonOffsetPrice:",s);const l=a(()=>[...e||[],...t||[]].reduce((e,t)=>e+t.price*t.count,0),[e,t]),c=(null!=r?r:200)+(null!=n?n:200),d=(null!=o?o:0)+(null!=s?s:0);return{addonsPrice:l,backPrice:n,bookingPrice:c,therePrice:r,totalPrice:c+l+d,CarbonOffsetPrice:d}},je=e=>{const r=i(Pe,e=>e.state.user.language),n=G[r],s=$e(ve.locations),c=i(ke,e=>e.state[ve.locations]),{locationsResponse:{error:d,loading:u},locations:p}=l(Le),g=o(e=>{if(p)for(const t of p)for(const a of t.stations)if(a.id===e)return R({},a,{cityId:t.id,cityName:t.name})},[p]),m=o(e=>null==p?void 0:p.find(t=>t.id===e),[p]),f=a(()=>e?null==p?void 0:p.sort((e,t)=>te(n,e.code)-te(n,t.code)).map(e=>R({},e,{stations:e.stations.sort((e,t)=>t.significance-e.significance)})):p,[p]);return t(()=>{var e;s((null==d||null==(e=d.response)||null==(e=e.data)?void 0:e.message)||$(d),!!u)},[d,u]),R({data:f,getCity:m,getDestination:e=>{var t;return null!=(t=g(e))?t:m(e)},getStation:g},c)},Ke=["returnDepartureDate","fromLocationName","toLocationName","departureDate"],ze=[5577656005,5577656007,5577656006,5362691025],We=Object.freeze({10202001:3088864005}),qe="/routes/search/simple",Ve={Accept:"application/1.2.0+json"},Qe=["HR"],Ze=()=>{const e=i(Pe,e=>{var t;return null==(t=e.state.user.user)?void 0:t.creditPrice}),t=n(),o=n({}),[{data:s,loading:l},c]=we({url:qe,method:"GET",headers:Ve}),[d,u]=r(),{getCity:p,getStation:g}=je(),[m,f]=r(!1),h=a(()=>!(null==s||!s.routes.some(({transfersCount:e,vehicleTypes:t,arrivalStationId:a,departureStationId:r})=>!e&&t.includes("TRAIN")&&!(ze.includes(a)||ze.includes(r)))),[s]),y=s&&{routesMessage:null!=d&&d.routesMessage&&s.routesMessage&&(null==d?void 0:d.routesMessage)!==s.routesMessage?[s.routesMessage,null==d?void 0:d.routesMessage].join("\n"):s.routesMessage||(null==d?void 0:d.routesMessage)||null,textBubbles:null!=d&&d.textBubbles.length?[...s.textBubbles,...d.textBubbles].filter((e,t,a)=>t===a.findIndex(t=>t.id===e.id&&t.text===e.text)):s.textBubbles,routes:(d?[...s.routes,...d.routes]:s.routes).sort((e,t)=>new Date(e.departureTime).valueOf()-new Date(t.departureTime).valueOf()).map(t=>R({},t,{priceFrom:e?t.creditPriceFrom:t.priceFrom,priceTo:e?t.creditPriceTo:t.priceTo}))},T=async(e,t,a,r)=>{try{var n,s;d&&u(void 0);const i=!!We[e.fromLocationId]&&Qe.includes("CITY"===e.toLocationType?null==(n=p(e.toLocationId))?void 0:n.code:null==(s=g(e.toLocationId))?void 0:s.countryCode),[{headers:l},m]=await Promise.all([c({headers:R({},t,Ve),params:R({},e,{departureDate:e.departureDate.slice(0,10)},a&&{move:a}),signal:r}),i&&D.get(qe,{headers:t,signal:r,params:R({},e,{fromLocationId:We[e.fromLocationId],fromLocationType:"STATION",departureDate:e.departureDate.slice(0,10)},a&&{move:a})})]);return m&&u(m.data),o.current={"x-used-departurefromdatetime":l["x-used-departurefromdatetime"],"x-used-departuretodatetime":l["x-used-departuretodatetime"]},!0}catch(e){return!1}};return{data:y,fetchBackwardRoutes:async(e,a)=>{try{return await T(t.current,R({},o.current,e),"BACKWARD",a)}catch(e){return!1}},fetchConnection:async(e,a)=>{let{returnDepartureDate:r,fromLocationName:n,toLocationName:o,departureDate:s}=e,i=v(e,Ke);try{t.current=R({},i,{departureDate:s});const e=R({},i,{departureDate:s,returnDepartureDate:r,fromLocationName:n,toLocationName:o});return await T(e,{},void 0,a)}catch(e){return!1}},fetchForwardRoutes:async(e,a)=>{try{return await T(t.current,R({},o.current,e),"FORWARD",a)}catch(e){return!1}},fetchSroRoutes:async(e,t)=>{f(!0);const[a,r]=await Promise.all([2,1].map(a=>D.get("/routes/search/RJ_SRO",{params:R({},e,{seatClass:a}),signal:t})));return f(!1),a.data.map((t,a)=>{const n=r.data[a];return R({},t,n?{pricesCount:t.pricesCount+n.pricesCount,creditPriceFrom:Math.min(t.creditPriceFrom,n.creditPriceFrom)*e.numberOfPassengers,creditPriceTo:Math.max(t.creditPriceTo,n.creditPriceTo)*e.numberOfPassengers,priceFrom:Math.min(t.priceFrom,n.priceFrom)*e.numberOfPassengers,priceTo:Math.max(t.priceTo,n.priceTo)*e.numberOfPassengers,freeSeatsCount:t.freeSeatsCount+n.freeSeatsCount}:{creditPriceFrom:t.creditPriceFrom*e.numberOfPassengers,creditPriceTo:t.creditPriceTo*e.numberOfPassengers,priceFrom:t.priceFrom*e.numberOfPassengers,priceTo:t.priceTo*e.numberOfPassengers})})},loading:l||m,shouldFindSro:h}},et=["selectedSeats"],tt=["selectedSeats"];var at,rt;!function(e){e.email="EMAIL",e.firstName="FIRST_NAME",e.surname="SURNAME",e.phone="PHONE",e.customerName="CUSTOMER_NAME",e.customerAddress="CUSTOMER_ADDRESS",e.dateOfBirth="BIRTHDAY"}(at||(at={})),function(e){e.email="email",e.firstName="firstName",e.phone="phone",e.surname="surname",e.customerName="customerName",e.customerAddress="customerAddress",e.dateOfBirth="dateOfBirth"}(rt||(rt={}));const nt={CUSTOMER_ADDRESS:rt.customerAddress,CUSTOMER_NAME:rt.customerName,EMAIL:rt.email,FIRST_NAME:rt.firstName,PHONE:rt.phone,SURNAME:rt.surname,BIRTHDAY:rt.dateOfBirth},ot=["RJ_TIME","FLEXI"],st=()=>{var e;const r=i(Se,e=>{var t;return null==(t=e.state.booking)?void 0:t.connection}),n=i(Se,e=>{var t;return null==(t=e.state.booking)?void 0:t.there}),o=i(Se,e=>{var t;return null==(t=e.state.booking)?void 0:t.back}),s=$e(ve.passengersData),[{data:l,loading:c,error:d},u]=we({}),[{data:p,loading:g,error:m},f]=we({}),h=c||g,y=d||m,T=a(()=>{var e,t;if(!l||null!=o&&o.routeId&&!p||!r)return{contactData:{email:!0},personalData:{from:null==r?void 0:r.fromLocationName,passengers:[],to:null==r?void 0:r.toLocationName}};const a=!p||l.otherPassengersData.length>p.otherPassengersData.length?l:p;return{contactData:{email:!0,phone:a.firstPassengerData.some(e=>e.includes(at.phone))},personalData:{from:r.fromLocationName,to:r.toLocationName,passengers:Array.from({length:null!=(e=null==(t=n||o)||null==(t=t.tariffs)?void 0:t.length)?e:1}).map((e,t)=>{var r;return{fields:(t?a.otherPassengersData:a.firstPassengerData.filter(e=>!["EMAIL","PHONE"].includes(e))).map(e=>({name:nt[e],value:""})),tariff:null==(r=n||o)||null==(r=r.tariffs)?void 0:r[t]}})}}},[l,p]);return t(()=>{var e;s(null==y||null==(e=y.response)||null==(e=e.data)?void 0:e.message,h)},[h,y]),t(()=>{if(null==o||!o.routeId||!o.type||ot.includes(o.type))return;const e=new AbortController,t=e.signal;var a;return f("RJ_SRO"===(null==o?void 0:o.type)?{params:{departureDate:new Date,fromStationId:null==o?void 0:o.fromStationId,numberOfPassenger:null==o||null==(a=o.tariffs)?void 0:a.length,routeId:null==o?void 0:o.routeId,seatClass:1,toStationId:null==o?void 0:o.toStationId},signal:t,url:`/routes/${null==o?void 0:o.routeId}/passengersData/RJ_SRO`}:{data:{priceSource:null==o?void 0:o.priceSource,seatClass:null==o?void 0:o.seatClass,sections:((null==o?void 0:o.sections)||[]).map(e=>v(e,et)),tariffs:null==o?void 0:o.tariffs},method:"POST",signal:t,url:`/routes/${null==o?void 0:o.routeId}/passengersData`}),()=>{e.abort()}},[null==o?void 0:o.routeId]),t(()=>{if(null==n||!n.routeId||!n.type||ot.includes(n.type))return;const e=new AbortController,t=e.signal;var a;return u("RJ_SRO"===(null==n?void 0:n.type)?{params:{departureDate:new Date,fromStationId:null==n?void 0:n.fromStationId,numberOfPassenger:null==n||null==(a=n.tariffs)?void 0:a.length,routeId:null==n?void 0:n.routeId,seatClass:1,toStationId:null==n?void 0:n.toStationId},signal:t,url:`/routes/${null==n?void 0:n.routeId}/passengersData/RJ_SRO`}:{data:{priceSource:null==n?void 0:n.priceSource,seatClass:null==n?void 0:n.seatClass,sections:((null==n?void 0:n.sections)||[]).map(e=>v(e,tt)),tariffs:null==n?void 0:n.tariffs},method:"POST",signal:t,url:`/routes/${null==n?void 0:n.routeId}/passengersData`}),()=>{e.abort()}},[null==n?void 0:n.routeId]),{data:T,error:null==y||null==(e=y.response)?void 0:e.data.message,loading:h}},it=e=>{const a=i(Pe,e=>e.state.user),r=i(Pe,e=>e.state.user.currency),n=$e(ve.credit),o=i(ke,e=>e.state[ve.credit]),[{error:s,loading:l},c]=we({url:"/payments/credit/add",method:"POST"});return t(()=>{var e;n(null==s||null==(e=s.response)||null==(e=e.data)?void 0:e.message,l)},[s,l]),R({addCredit:async(t,n,o=!1,s=void 0,i={},l)=>{if(a.user){const d=o?(s||H(e)).map(e=>`${e.type}=${e.id}`).join("&"):null;try{const e={amount:"EUR"===r?parseFloat(t.toFixed(1)):t,currency:r,paymentMethodCode:a.paymentMethodCode,correlationId:"credit"+(d?`&${d}`:""),formFields:[{fieldType:at.email,fieldValue:(null==i?void 0:i.email)||a.user.email},i.firstName&&{fieldType:at.firstName,fieldValue:i.firstName},i.surname&&{fieldType:at.surname,fieldValue:i.surname},i.customerName&&{fieldType:at.customerName,fieldValue:i.customerName},i.customerAddress&&{fieldType:at.customerAddress,fieldValue:i.customerAddress}].filter(Boolean),rememberCard:n};W({event:"ADD_CREDIT",ADD_CREDIT:e});const{data:o}=await c({data:e,signal:l});return o.payRedirectUrl}catch(e){}}}},o)},lt=(e,a=10)=>{const r=i(Pe,e=>e.state.user.language),[{loading:n,error:o,data:s},l]=De({headers:{Accept:"application/1.1.0+json"},method:"GET",url:`/routes/${e}/departures?limit=${a}`});return t(()=>{D.defaults.headers.common["X-Lang"]="de-AT"===r?"at":r;const e=new AbortController;return l({signal:e.signal}),()=>{e.abort()}},[r]),{data:s,error:o,fetchDepartures:l,loading:n}},ct=e=>{const[{data:a=[],loading:r},n]=we({method:"GET",url:"/consts/cityPairs"});return t(()=>{if(!e)return;const t=new AbortController;return n({params:{fromCityId:e},signal:t.signal}),()=>{t.abort()}},[e]),{cityPairs:a,loading:r}},dt=["routeId"],ut=[],pt="2022-01-01",gt=(e=!1)=>{const r=$e(ve.connectionRoute),n=i(Pe,e=>{var t;return null==(t=e.state.user.user)?void 0:t.creditPrice}),[{data:s,error:l,loading:c},d]=we({}),[{loading:u,error:p,data:g},m]=we({}),[{loading:f,error:h,data:y},T]=we({}),S=u||f,E=p||h,k=a(()=>s&&R({},s,{priceFrom:n?s.creditPriceFrom:s.priceFrom,priceClasses:s.priceClasses.map(e=>R({},e,{price:n?e.creditPrice:e.price,type:"RJ_SEAT"}))}),[s,n]),C=o(async(e,t)=>{try{return(await d({url:`/routes/${e.routeId}/simple`,params:e,signal:t})).data}catch(e){return}},[d]),_=o(async(e,t)=>{let{routeId:a}=e,r=v(e,dt);const n=R({},r,{numberOfPassengers:r.tariffs.length}),o=`/routes/${a}/RJ_SRO`;try{return(await Promise.all([T({params:R({},n,{departureDate:pt,seatClass:2}),signal:t,url:o}),m({params:R({},n,{departureDate:pt,seatClass:1}),signal:t,url:o})])).flatMap(e=>e.data.priceClasses)}catch(e){return}},[m,T]),I=c||S,b=l||E;return t(()=>{var t,a;e||r((null==b||null==(t=b.response)||null==(t=t.data)?void 0:t.message)||$(b),I,null==b||null==(a=b.response)||null==(a=a.data)?void 0:a.errorFields)},[I,b]),{data:k,fetchRoute:C,fetchSroRoutes:_,rjSroClasses:a(()=>{var e,t;return null!=g&&g.priceClasses.length||null!=y&&y.priceClasses.length?[...null!=(e=null==g?void 0:g.priceClasses)?e:[],...null!=(t=null==y?void 0:y.priceClasses)?t:[]].map(e=>R({},e,{tariffs:new Array(e.numberOfPassengers).fill(A.Regular),price:e.price*e.numberOfPassengers,type:"RJ_SRO"})):ut},[g,y]),routeError:b,routeLoading:I}},mt=()=>{const[{data:e,loading:t},r]=we({}),n=async(e,t,a)=>{try{const{routeId:n,fromStationId:o,toStationId:s,tariffs:i}=e;return!Z(o,s)||1!==i.length||(await r({signal:a,url:`/pricelists/timeticket/${n}/${o}/${s}/FLEX/${t}/${i[0]}`}),!0)}catch(e){return!1}};return a(()=>({data:e,fetchRoute:n,loading:t}),[t,e])};var ft;!function(e){e.Week="WEEK",e.Month="MONTH",e.Quarter="QUARTER"}(ft||(ft={}));const ht=[ft.Week,ft.Month,ft.Quarter],yt=()=>{const e=i(Se,e=>{var t;return null==(t=e.state.booking)?void 0:t.connection.departureDate}),[{data:t,loading:r,error:n},o]=we({}),[{data:s,loading:l,error:c},d]=we({}),[{data:u,loading:p,error:g},m]=we({}),f=r||l||p,h=n||c||g,y=!!(null!=t&&t.length&&null!=s&&s.length&&null!=u&&u.length);return{data:a(()=>(y?[t,s,u]:[]).flatMap((e,t)=>e.map(({price:e,seatClassKey:a,lineNumber:r,lineGroupCode:n})=>({flexiType:ht[t],lineGroupCode:n,lineNumber:r,price:e,seatClassKey:a,type:"FLEXI"}))),[y]),error:h,fetchRoute:async({fromStationId:t,toStationId:a,tariffs:r,routeId:n},s)=>{await Promise.all([o({signal:s,url:`/pricelists/timeticket/${n}/${t}/${a}/${ft.Week}/${e}/${r[0]}`}),d({signal:s,url:`/pricelists/timeticket/${n}/${t}/${a}/${ft.Month}/${e}/${r[0]}`}),m({signal:s,url:`/pricelists/timeticket/${n}/${t}/${a}/${ft.Quarter}/${e}/${r[0]}`})])},loading:f}},Tt="SET_LOGIN_NR",St="SET_USER",Et=e=>D.get("/users/authenticate",e),Rt=()=>{const e=i(Pe,e=>e.dispatch.userDispatch),t=i(Pe,e=>!!e.state.user.user),a=t=>{t!==D.defaults.headers.common["X-Currency"]&&e({type:"SET_CURRENCY",payload:{currency:t}})},r=async t=>{let r;try{r=await Et({signal:t})}catch(e){r=await Et({hideTokenHash:!0,signal:t})}const n=r.data;if(n)return e({type:St,payload:{user:n}}),n.creditPrice&&e({type:Tt,payload:{loginNr:n.accountCode}}),a(n.currency),n};return{authorize:r,setCaptcha:e=>{t||(D.defaults.headers.common["X-ReCaptcha-Token"]=e)},setCurrency:a,setLanguage:t=>{t!==D.defaults.headers.common["X-Lang"]&&e({type:"SET_LANG",payload:{language:t}})},setToken:async t=>{if(t)return D.defaults.headers.Authorization=`Bearer ${t}`,e({type:"SET_TOKEN",payload:{token:t}}),await r();delete D.defaults.headers.Authorization,e({type:"CLEAR_USER"})}}},vt=()=>{const{currency:e,language:t,token:a}=i(Pe,e=>e.state.user);return{currency:e,language:t||"cs",token:a}},At=()=>{const e=$e(ve.user),a=i(ke,e=>e.state[ve.user]),r=i(Pe,e=>e.dispatch.userDispatch),n=i(Pe,e=>e.state.user.user),{setToken:o}=Rt(),{clearBooking:s}=He(),[{error:l,loading:c},d]=we({url:"/users/signup/registeredAccount",method:"POST"}),[{error:u,loading:p},g]=we({url:"/users/login/registeredAccount",method:"POST"}),[{error:m,loading:f},h]=we({url:"/users/forgottenPassword",method:"POST"}),[{error:y,loading:T},S]=we({url:"/users/login/unregisteredAccount",method:"POST"}),[{error:E,loading:v},A]=we({url:"/users/logout",method:"POST",data:{}},{manual:!0}),[{error:k,loading:C},_]=we({url:"/users/settings/changeUserInformation",method:"PUT"}),[{error:I,loading:b},O]=we({url:"/users/settings/changePassword",method:"PUT"}),[{error:P,loading:N},D]=we({url:"/users/resetPassword",method:"POST"}),[{error:w,loading:L},U]=we({url:"/users/resetPassword/verify",method:"GET"}),[{error:M,loading:J,data:F},B]=we({url:"/tickets/account/qrcode",method:"GET"}),[{error:G,loading:Y,data:H},X]=we({url:"/discounts/percentual",method:"GET",headers:{Accept:"application/1.1.0+json"}}),[{error:j,loading:K},z]=we({url:"/users/signup/registeredAccount/simple",method:"POST"}),W=C||b||f||p||T||v||Y||J||K||N||L||c,q=k||I||m||u||y||E||G||M||j||P||w||l;return t(()=>{var t,a;e((null==q||null==(t=q.response)||null==(t=t.data)?void 0:t.message)||$(q),W,null==q||null==(a=q.response)||null==(a=a.data)?void 0:a.errorFields)},[q,W]),R({addLoginNumber:async e=>r({type:Tt,payload:{loginNr:e}}),changeUserInfo:async(e,t)=>{try{if(n){const{companyInformation:a,company:o,defaultTariffKey:s,notifications:i,phoneNumber:l}=n;return await _({data:R({companyInformation:a,company:o,defaultTariffKey:s,notifications:i,phoneNumber:l},e),signal:t}),r({type:St,payload:{user:n&&R({},n,e,{company:e.company?e.company:o})}}),!0}}catch(e){return!1}},changeUserPassword:async(e,t)=>{try{return await O({data:e,signal:t}),!0}catch(e){return!1}},login:async(e,t)=>{try{const a=await g({data:e,signal:t});return{response:a,user:await o(a.data.token)}}catch(e){}},loginTicket:async(e,t)=>{try{const a=await S({data:{accountCode:e},signal:t});return{response:a,user:await o(a.data.token)}}catch(e){}},logout:async e=>{try{return await A({signal:e}),await o(null),s(),!0}catch(e){return!1}},registerOpenTicket:async(e,t)=>{try{const a=await z({data:e,signal:t});return a.data.token&&await o(a.data.token),!0}catch(e){return!1}},requestPasswordReset:async(e,t)=>{try{return await h({data:e,signal:t}),!0}catch(e){return!1}},register:async(e,t)=>{try{const{data:a,status:r}=await d({data:e,signal:t});return 200===r&&(await o(a.token),!0)}catch(e){return!1}},resetPassword:async(e,t,a)=>{try{const r={Authorization:`Bearer ${t}`},{status:n}=await U({headers:r,signal:a}),{status:o}=await D({data:{newPassword:e},headers:r,signal:a});return 200===n&&200===o}catch(e){return!1}},setPaymentCode:e=>(!e||!x.includes(e))&&r({type:"SET_PAYMENT_CODE",payload:{paymentMethodCode:e}}),accountQr:{getAccountQr:B,qrData:F},percDiscounts:{getPercDiscounts:X,percDiscountsData:H}},a)},kt=()=>{const e=i(Pe,e=>e.state.user),{user:t}=e;return{isCreditPrice:!(null==t||!t.creditPrice),isLoggedIn:!!t,loginNumbers:e.loginNrs,user:e}},Ct={RJ_SEAT:[],RJ_SRO:[],RJ_TIME:[]},_t=Object.freeze({RJ_SEAT:0,RJ_SRO:0,RJ_TIME:0}),It=Object.freeze({CANCELED:{limit:10},UNPAID:{limit:99,sortDirection:"ASC"},USED:{limit:5},VALID:{limit:10,sortDirection:"ASC"}}),bt={RJ_SEAT:"/tickets",RJ_SRO:"/tickets/RJ_SRO",RJ_TIME:"/tickets/RJ_TIME"},Ot=(e,{unpaid:t})=>t+e,Pt=e=>+new Date(e.expirationDate||e.conditions.expireAt||e.conditions.expiration||0)>+(new Date).valueOf(),Nt=(e,s=!0,l)=>{const c=i(Pe,e=>e.state.user.token),p=i(Pe,e=>e.interceptorsMounted),m=$e(ve.userTickets),f=i(ke,e=>e.state[ve.userTickets].error),[h,y]=d(void 0),[T,S]=r(!1),[E,v]=r(!1),A=n(_t),k=n(R({},_t));h&&(k.current.RJ_SEAT=h.RJ_SEAT.length,k.current.RJ_SRO=h.RJ_SRO.length,k.current.RJ_TIME=h.RJ_TIME.length);const C=a(()=>R({},It[e],l,{ticketStates:[e]}),[e]),_=h?{RJ_SEAT:h.RJ_SEAT.length<A.current.RJ_SEAT,RJ_SRO:h.RJ_SRO.length<A.current.RJ_SRO,RJ_TIME:h.RJ_TIME.length<A.current.RJ_TIME}:{},I=a(()=>h?h.RJ_SEAT.reduce(Ot,0)+h.RJ_SRO.reduce(Ot,0)+h.RJ_TIME.reduce(Ot,0):0,[h]),b=A.current.RJ_SEAT+A.current.RJ_SRO+A.current.RJ_TIME,O=T||!h?0:h.RJ_SEAT.length+h.RJ_SRO.length+h.RJ_TIME.length,P=o(async(t,a)=>{try{if(D.defaults.headers.Authorization){m(void 0,!1),S(!0);const[{data:r,headers:n},{data:o,headers:s},{data:i,headers:l}]=await Promise.all([D.get(bt.RJ_SEAT,{headers:{Accept:"application/1.2.0+json"},params:a&&k.current.RJ_SEAT?R({},C,{limit:k.current.RJ_SEAT}):C,signal:t}),D.get(bt.RJ_SRO,{params:a&&k.current.RJ_SRO?R({},C,{limit:k.current.RJ_SRO}):C,signal:t}),D.get(bt.RJ_TIME,{params:a&&k.current.RJ_TIME?R({},C,{limit:k.current.RJ_TIME}):C,signal:t})]);A.current={RJ_SEAT:parseInt(n["x-pagination-total"]),RJ_SRO:parseInt(s["x-pagination-total"]),RJ_TIME:parseInt(l["x-pagination-total"])},y(((e,{RJ_SEAT:t,RJ_SRO:a,RJ_TIME:r})=>{const n=t=>R({},t,{state:e});return"UNPAID"!==e?{RJ_SEAT:t.map(n),RJ_SRO:a.map(n),RJ_TIME:r.map(n)}:{RJ_SEAT:t.map(n).filter(Pt),RJ_SRO:a.map(n).filter(Pt),RJ_TIME:r.map(n).filter(Pt)}})(e,{RJ_SEAT:r,RJ_SRO:o,RJ_TIME:i.tickets})),S(!1)}else A.current=_t,y(Ct);return!0}catch(e){var r;return S(!1),u.isCancel(e)||(A.current=_t,y(void 0),m(g(e)?(null==(r=e.response)?void 0:r.data.message)||$(e):F,!1)),!1}},[e]),N=o(async(t,a)=>{try{if(D.defaults.headers.Authorization&&null!=h&&h[t].length){v(!0);const{data:r}=await D.get(bt[t],{params:R({},C,{offset:h[t].length}),headers:"RJ_SEAT"===t?{Accept:"application/1.2.0+json"}:void 0,signal:a}),n=((e,t,a)=>{const r=t=>R({},t,{state:e});return"UNPAID"!==e?a.map(r):a.filter(Pt).map(r)})(e,0,"RJ_TIME"===t?r.tickets:r);if(!n.length)return;y(e=>{null==e||e[t].push(...n)}),v(!1)}else A.current=_t,y(void 0)}catch(e){var r;y(void 0),m(g(e)?(null==(r=e.response)?void 0:r.data.message)||$(e):F,!1)}},[h,e]);return t(()=>{s&&D.defaults.headers.Authorization&&p?(A.current=_t,y(void 0),P()):D.defaults.headers.Authorization||(A.current=_t,y(void 0))},[e,c,p]),{error:f,fetchMore:N,fetchTickets:P,fetchedCount:O,loading:T,loadingMore:E,shouldFetchMore:_,tickets:h,totalCount:b,totalPrice:I}},Dt=["email"],wt={headers:{"Content-Type":"application/1.2.0+json"},method:"POST"},Lt=(e=Ct,r=!1,n="UNPAID")=>{const{authorize:o}=Rt(),{setPaymentCode:s}=At(),{user:l,paymentMethodCode:c}=i(Pe,e=>e.state.user),d=$e(ve.payment),u=i(ke,e=>e.state[ve.payment]),p=H("UNPAID"===n?e:{RJ_SEAT:e.RJ_SEAT.filter(e=>e.unpaid),RJ_SRO:[],RJ_TIME:[]}),[{data:g,error:m,loading:f},h]=we({headers:{"Content-Type":"application/1.1.0+json"},method:"POST",url:"/payments/methods"}),[{data:y,error:T,loading:S},E]=we({method:"POST",url:"/payments/form"}),[{error:A,loading:k},C]=we(R({url:"/payments/pay"},wt)),[{error:_,loading:I},b]=we({url:"/payments/credit/giftCertificate/add",method:"POST"}),[{error:O,loading:P},N]=we(R({url:"/payments/credit/charge"},wt)),D=a(()=>null==g?void 0:g.filter(e=>e.active&&e.paymentType),[g]),w=m||T||A||_||O,L=f||S||k||I||P;return t(()=>{var e;d(null==w||null==(e=w.response)||null==(e=e.data)?void 0:e.message,L)},[w,L]),t(()=>{c&&null!=D&&D.length&&!D.some(e=>e.paymentMethodCode===c)&&s(null)},[D]),t(()=>{const e=new AbortController,t=e.signal;return!r&&null!=p&&p.length?h({data:{ticketIds:p},signal:t}):r&&h({data:{ticketIds:[]},signal:t}),()=>{e.abort()}},[e,r]),R({addCreditByGift:async(e,t)=>{try{return await b({data:e,signal:t}),!0}catch(e){return!1}},buyTickets:async(e=!1,t={},a=p,r=!1,n,s)=>{try{const i=R({},wt.headers,{"X-TxToken":X()}),{email:d=(null==l?void 0:l.email)}=t,u=v(t,Dt),p=[{fieldType:at.email,fieldValue:d},...Object.entries(u).filter(([,e])=>e).map(([e,t])=>({fieldType:at[e],fieldValue:t}))],g=`tickets&${a.map(e=>`${e.type}=${e.id}`).join("&")}`;if(l&&r)return await N({data:R({tickets:a},null!=p&&p.length&&s?{formFields:p}:{}),headers:i,signal:n}),await o(n),{type:"credit",url:g};const m={correlationId:g,formFields:p,paymentMethodCode:c,rememberCard:e,tickets:a};W({event:"PAY",PAY:m});const{data:f}=await C({data:m,headers:i,signal:n});return{type:"payment",url:f.payRedirectUrl}}catch(e){}return null},getPaymentForm:async(e,t,a)=>{try{const{data:n}=await E({data:R({paymentMethodCode:t||c},r?{tickets:[]}:{ticketIds:e?[e]:p}),headers:R({},r?{}:{"Content-Type":"application/1.1.0+json"}),signal:a});return n}catch(e){}},getPaymentMethods:async(e,t)=>{try{await h({data:{ticketIds:r?[]:e||p},signal:t})}catch(e){}},paymentForm:y,paymentFormLoading:S,paymentMethodsLoading:f,paymentMethods:D,ticketsAvailable:!(null==p||!p.length)},u)},Ut=["addonCode"],Mt=()=>{var e,a;const r=i(Pe,e=>!!e.state.user.user),{setToken:n}=Rt(),o=$e(ve.createTickets),s=i(ke,e=>e.state[ve.createTickets]),{clearBooking:l}=He(),c=i(Se,e=>{var t;return null==(t=e.state.booking)?void 0:t.there}),d=i(Se,e=>{var t;return null==(t=e.state.booking)?void 0:t.back}),u=i(Se,e=>{var t;return null==(t=e.state.booking)?void 0:t.connection});i(Se,e=>{var t;return null==(t=e.state.booking)||null==(t=t.there)?void 0:t.carbonOffset});const{buyTickets:p,loading:g,error:m}=Lt(),f=(null!=(e=null==c?void 0:c.price)?e:0)+(null!=(a=null==d?void 0:d.price)?a:0),[{loading:h,error:y},T]=we({url:"/tickets/create/unregistered",method:"POST",headers:{"Content-Type":"application/1.2.0+json"}}),[{loading:S,error:E},C]=we({url:"/tickets/create/registered",method:"POST",headers:{"Content-Type":"application/1.2.0+json"}}),[{loading:_,error:I},b]=we({url:"/tickets/timetickets/unregistered",method:"POST"}),[{loading:O,error:P},N]=we({url:"/tickets/timeticket",method:"POST"}),[{loading:w,error:L},U]=we({url:"/tickets/RJ_SRO/unregistered",method:"POST"}),[{loading:M,error:J},F]=we({url:"/tickets/RJ_SRO/registered",method:"POST"}),B=I||y||L||J||P||E,$=_||h||w||M||O||S||g;return t(()=>{var e;o((null==B||null==(e=B.response)||null==(e=e.data)?void 0:e.message)||(null==m?void 0:m.message),$)},[B,$]),R({createTickets:async(e,t,a,o,s)=>{try{if(!u)throw new Error("no connection");const g=[c,d].filter(Boolean),m=g.filter(e=>"RJ_SEAT"===e.type),h=g.filter(e=>"RJ_SRO"===e.type),y=g.filter(e=>["RJ_TIME","FLEXI"].includes(e.type));let S,E=null;const _=r=>t.length?t.map(({fields:t},n)=>R({},t,{tariff:r[n]||A.Regular,phone:n?void 0:a,email:n?void 0:e})):r.map((t,r)=>R({tariff:t},r?{}:{phone:a,email:e})),I={ticketRequests:m.map(e=>({passengers:_((null==e?void 0:e.tariffs)||[]),route:{routeId:(null==e?void 0:e.routeId)||"",priceSource:(null==e?void 0:e.priceSource)||"",sections:((null==e?void 0:e.sections)||[]).map(({sectionId:e,fromStationId:t,toStationId:a,selectedSeats:r})=>({section:{fromStationId:t,sectionId:e,toStationId:a},selectedSeats:(r||[]).map(t=>R({},t,{sectionId:e}))})),seatClass:(null==e?void 0:e.seatClass)||k.No},selectedAddons:((null==e?void 0:e.selectedAddons)||[]).map(e=>v(e,Ut)),percentualDiscountIds:e.percentualDiscountIds||[],codeDiscount:e.codeDiscount})),affiliateCode:q()},O=I.ticketRequests.flatMap(e=>e.route.sections.flatMap(e=>e.selectedSeats)),P={ticketRequests:h.map(t=>({routeId:t.routeId,seatClass:t.seatClass,passengers:((null==t?void 0:t.tariffs)||[]).map(()=>({email:e})),sections:((null==t?void 0:t.sections)||[]).map(({sectionId:e,fromStationId:t,toStationId:a,selectedSeats:r})=>({section:{fromStationId:t,sectionId:e,toStationId:a},selectedSeats:(r||[]).map(t=>R({},t,{sectionId:e}))})),priceSourceId:t.priceSource}))},w={unregisteredTimeTicketCreateRequest:y.map(t=>({email:e,lineGroupCode:t.lineGroupCode,lineNumber:t.lineNumber,seatClassKey:t.seatClass,station1Id:t.fromStationId,station2Id:t.toStationId,tariff:t.tariffs[0],timeTicketType:t.flexiType||"FLEX",validFrom:u.departureDate}))},L={timeTicketRequests:y.flatMap(e=>(e.tariffs||[]).map(t=>({lineGroupCode:e.lineGroupCode,lineNumber:e.lineNumber,seatClass:e.seatClass,station1Id:e.fromStationId,station2Id:e.toStationId,tariff:t,type:e.flexiType||"FLEX",validFrom:u.departureDate})))};if(r){let r={tickets:[]};if(m.length){const{data:n}=await C({data:I,signal:s});r=n,S=n.tickets.map(({id:e})=>({type:"RJ_SEAT",id:parseInt(e,10)}));const c=r.tickets.flatMap(e=>e.routeSections.flatMap(e=>e.selectedSeats));if(0===m.reduce((e,{price:t})=>e+(t||0),0))return{redirect:"tickets",newSeats:ee(O,c),ticketTypeId:S};if(o){var i;const r=await p(!1,R({email:e,phone:a},(null==t||null==(i=t[0])?void 0:i.fields)||{}),S,!0,s);return l(),r?{redirect:"tickets",newSeats:ee(O,c),ticketTypeId:S}:{redirect:"checkout",newSeats:[],ticketTypeId:S}}}if(y.length){const{data:e}=await N({data:L,headers:{"X-TxToken":X(),"Content-Type":"application/1.2.0+json"},signal:s});if(o)return S=e.map(e=>({type:"RJ_TIME",id:e})),await p(!1,t[0].fields,S,!0,s),l(),{redirect:"tickets",newSeats:[],ticketTypeId:S}}if(h.length&&(await F({data:P,headers:{"X-TxToken":X()},signal:s}),o)){const{data:e}=await D.get("/tickets/RJ_SRO",R({params:{limit:1,ticketStates:["UNPAID"]}},void 0));return S=e.map(e=>({type:"RJ_SRO",id:e.sroTicketId})),await p(!1,t[0].fields,S,!0,s),l(),{redirect:"tickets",newSeats:[],ticketTypeId:S}}const n=r.tickets.flatMap(e=>e.routeSections.flatMap(e=>e.selectedSeats));E=ee(O,n)}else{let e=null;if(m.length){const{data:t}=await T({data:R({},I,{agreeWithTerms:!0}),signal:s});S=t.tickets.map(({id:e})=>({id:parseInt(e,10),type:"RJ_SEAT"}));const a=t.tickets.flatMap(e=>e.routeSections.flatMap(e=>e.selectedSeats));E=ee(O,a),e=t.token,D.defaults.headers.Authorization=`Bearer ${t.token}`}if(y.length)if(e)await N({data:L,headers:{"X-TxToken":X()},signal:s});else{const{data:t}=await b({data:w,headers:{"Content-Type":"application/1.2.0+json","X-TxToken":X()},signal:s});e=t.token.token,D.defaults.headers.Authorization=`Bearer ${t.token.token}`}if(h.length)if(e)await F({data:P,headers:{"X-TxToken":X()},signal:s});else{const{data:t}=await U({data:R({},P,{agreeWithTerms:!0}),headers:{"X-TxToken":X()},signal:s});e=t.token,D.defaults.headers.Authorization=`Bearer ${t.token}`}await n(e)}return l(),{redirect:f?"cart":"tickets",newSeats:E||[],ticketTypeId:S}}catch(e){return{redirect:"",newSeats:[]}}}},s)},Jt=e=>{const[{data:t=[],loading:a}]=De({url:`/consts/lines/${e}`,headers:{"X-Application-Origin":"WEB"},method:"GET"});return{data:t.filter(({lineGroupCode:e})=>["WEB","WEB1"].includes(e)),loading:a}};S.config.threshold=.2;const Ft=.1,Bt=e=>{const[t,a]=E(e.split(",")[0]).split(" - ");return a?[t,...t.split(/[ -]/g),a]:[t,...t.split(/[ -]/g)]},$t=(e,t)=>{const{name:a,aliases:r}=e,n=(e=>t=>Bt(t.toLowerCase()).some(t=>t.startsWith(e)))(t),o=e.stations;return n(a)||(null==o?void 0:o.some(e=>n(e.name)))||r.some(e=>E(e.toLowerCase()).startsWith(t))},Gt=e=>{const t=i(Pe,e=>e.state.user.language),r=e.length>=3,{data:n}=je(),o=a(()=>n?new S(n.map(e=>{return{country:(t=e.name,E(t.split(",")[1].trim())),aliases:e.aliases.map(E),name:Bt(e.name),fullName:E(e.name),stations:e.stations.map(e=>({aliases:e.aliases.map(E),name:Bt(e.name),fullName:E(e.name)}))};var t}),{includeScore:!0,keys:[{name:"country",weight:.5},{name:"fullName",weight:.5},{name:"name",weight:.9},{name:"aliases",weight:.2},{name:"stations.name",weight:.8},{name:"stations.fullName",weight:.4},{name:"stations.aliases",weight:.2}]}):void 0,[n]),s=a(()=>{if(!r||!o||null==n||!n.length)return[];const a=E(e).trim().toLowerCase();return o.search(a).map(e=>{const t=n[e.refIndex];var r;if(!t.stations.length)return R({},t,{refIndex:e.refIndex,score:e.score,significance:null!=(r=t.significance)?r:0});const o=new S(t.stations.map(t=>({country:e.item.country,aliases:t.aliases.map(E),name:Bt(t.name),fullName:E(t.name)})),{includeScore:!0,keys:["name","aliases","fullName","country"]}).search(a).sort(((e,t)=>(a,r)=>{const n=e[a.refIndex],o=e[r.refIndex];return+$t(o,t)-+$t(n,t)||(a.score>Ft||r.score>Ft?a.score-r.score:o.significance-n.significance||a.score-r.score)})(t.stations,a)).map(e=>t.stations[e.refIndex]);return R({},t,{refIndex:e.refIndex,score:e.score,significance:Math.max(...o.map(({significance:e})=>e)),stations:o})}).sort(((e,t)=>(a,r)=>{const n=+$t(r,e)-+$t(a,e);if(n)return n;if(a.score>Ft||r.score>Ft)return a.score-r.score;const o=r.significance-a.significance;if(o)return o;const s=G[t],i=te(s,a.code)-te(s,r.code);return i||o?i:a.score-r.score})(a,t)).slice(0,6)},[o,r&&e]);return{filtered:s,shouldSearch:r}};var xt;!function(e){e.ACCOUNT="ACCOUNT",e.BANK_TRANSFER="BANK_TRANSFER"}(xt||(xt={}));const Yt=()=>{const[{data:e,loading:t,error:a,response:r},n]=we({url:"/payments",method:"GET",headers:{Accept:"application/1.1.0+json"}}),o=Math.floor(+((null==r?void 0:r.headers["x-pagination-total"])||0)/10)+1;return{data:e,error:a,fetchInvoice:async(t,a,r)=>{try{const n=null==e?void 0:e.find(e=>e.paymentId===t),o=`/payments/${t}/print/${a||(null!=n&&n.ticketId?"invoice":"receipt")}`,{data:s}=await D.get(o,{signal:r});return s}catch(e){}},fetchInvoices:async(e,t)=>{try{const{data:a}=await D.post("/payments/print/invoice",{invoices:e},{signal:t});return a}catch(e){}},fetchPaymentsHistory:async(e,t=0,a)=>{try{await n({params:R({},e,{limit:10,offset:10*t}),signal:a})}catch(e){}},loading:t,pages:o}},Ht=e=>{const[{data:a,error:r,loading:n},o]=we({method:"POST"}),s=$e(ve.seats),l=i(ke,t=>null!=e&&e.ignoreGlobalState?void 0:t.state[ve.seats]);return t(()=>{var t;null!=e&&e.ignoreGlobalState||s(null==r||null==(t=r.response)||null==(t=t.data)?void 0:t.message,n)},[null==e?void 0:e.ignoreGlobalState,r,n]),R({data:a,fetchSeats:async(e,t)=>{try{return await o({url:"/routes/freeSeats",data:e,headers:{"Content-Type":"application/json"},signal:t}),!0}catch(e){return!1}},error:r,loading:n},l)},Xt=()=>{const e=$e(ve.tariffs),a=i(ke,e=>e.state[ve.tariffs]),{error:r,loading:n}=i(Le,e=>e.tariffsResponse),o=i(Le,e=>e.tariffs);return t(()=>{var t;e(null==r||null==(t=r.response)||null==(t=t.data)?void 0:t.message,!!n)},[r,n]),R({data:o},a)},jt=({id:e,type:a},n)=>{const{authorize:o}=Rt(),s=$e(ve.ticketAction),l=i(ke,e=>e.state[ve.ticketAction]),[c,d]=r(!1),[u,p]=r(),[{error:g,loading:m},f]=we({url:`/tickets/${a}/${e}/sendByEmail`,method:"POST"}),[{error:h,loading:y},T]=we({url:`/tickets/${a}/${e}/pdf`,method:"GET",responseType:"blob"}),[{error:S,loading:E},v]=we({method:"PUT",url:`/tickets/${e}/submitWheelChairPlatformOrder`}),[{error:k,loading:C},_]=we({url:`/tickets${"RJ_TIME"===a?"/timeticket":""}/${e}/qrcode`,method:"GET"}),[{data:I}]=(n?De:we)({url:`/tickets/${n}/questionnaireUrls`,method:"GET"}),[{error:b,loading:O},P]=we({url:`/tickets/${e}/cancel`,method:"PUT"}),[{error:N,loading:w},L]=we({url:`/tickets/timeticket/${e}`,method:"DELETE"}),[{error:U,loading:M},J]=we({url:`/tickets/RJ_SRO/${e}`,method:"DELETE"}),[{error:F,loading:B},$]=we({url:`/tickets/${e}`,method:"GET",headers:{Accept:"application/1.2.0+json"}}),G=[2,a,e].join(";"),x=g||h||k||S||b||N||U||u||F,Y=m||y||C||E||O||w||M||c||B;return t(()=>{var e;s(null==x||null==(e=x.response)||null==(e=e.data)?void 0:e.message,Y)},[x,Y]),R({cancel:async(e,t=!1,r)=>{try{const n={controlHash:e,refundToOriginalSource:t};let s=500;switch(a){case"RJ_SEAT":{const{data:e,status:a}=await $({signal:r}),o=a>=200&&a<300?{controlHash:e.conditions.code,refundToOriginalSource:t}:n,{status:i}=await P({data:o,signal:r});s=i;break}case"RJ_TIME":{const{status:e}=await L({signal:r});s=e;break}case"RJ_SRO":{const{status:e}=await J({data:n,headers:{"X-TxToken":X()},signal:r});s=e;break}}return await o(r),{status:s>=200&&s<300}}catch(e){}},getAppleWalletFile:async(e,t)=>{d(!0);try{const{data:a}=await D.get(`/apple-wallet/${n}/${e}`,{headers:{Accept:"application/vnd.apple.pkpass"},responseType:"blob",signal:t});return a}catch(e){p(e)}finally{d(!1)}},getPdf:T,getQr:_,orderWheelChairPlatform:async(e,t)=>{try{return v({data:e,signal:t}),!0}catch(e){return!1}},partialCancel:async(e,t,a,r=!1,n)=>{try{d(!0);let o=!0;const s=async(t,s)=>{try{const i=a.map(e=>e[s]),l=await D.delete(`/tickets/${e}/passengers/${t.id}`,{data:{refundToOriginalSource:r,seats:i},signal:n});(l.status<200||l.status>=300)&&(o=!1)}catch(e){o=!1}},i=t.filter(e=>e.tariff===A.DisabledAttendance),l=t.filter(e=>e.tariff!==A.DisabledAttendance);return await Promise.all(i.map((e,t)=>s(e,t))),await Promise.all(l.map((e,t)=>s(e,t+i.length))),{status:o}}catch(e){return p(e),{status:!1}}finally{d(!1)}},qrText:G,questionnaireUrls:I,sendByEmail:async(e,t)=>{try{return await f({data:{email:e},signal:t}),!0}catch(e){return!1}}},l)},Kt=["loading"],zt=({ticketId:e,luh:a})=>{const r=$e(ve.ticketReview),n=i(Pe,e=>e.state.user.token),[{data:o,loading:s,error:l},c]=we({url:`/tickets/authenticate/${a}`,method:"POST",headers:{"Content-Type":"application/json"},data:{}}),[d,u]=we({url:`tickets/${e}/rating`,method:"GET"}),{loading:p}=d,g=v(d,Kt),[{loading:m,error:f},h]=we({url:`tickets/${e}/rating`,method:"PUT"});return t(()=>{const e=new AbortController,t=e.signal;return a&&null!=o&&o.token?u({headers:{Authorization:`Bearer ${null==o?void 0:o.token}`},signal:t}):!a&&n&&u({signal:t}),()=>{e.abort()}},[null==o?void 0:o.token]),t(()=>{if(!a)return;const e=new AbortController;return c({signal:e.signal}),()=>{e.abort()}},[a]),t(()=>{var e,t,a;r((null==(e=g.error)||null==(e=e.response)||null==(e=e.data)?void 0:e.message)||(null==l||null==(t=l.response)||null==(t=t.data)?void 0:t.message)||(null==f||null==(a=f.response)||null==(a=a.data)?void 0:a.message),s||p||m)},[g.error,l,f,p,s,p]),{reviewForm:g,loading:s||p||m,sendReview:async(e,t)=>{try{return await h({data:e,headers:a?{Authorization:`Bearer ${null==o?void 0:o.token}`}:void 0,signal:t}),W({event:"SENT_REVIEW",SENT_REVIEW:e}),!0}catch(e){return!1}}}},Wt=Object.freeze({FLEXI:"/",RJ_SEAT:"/tickets/",RJ_SRO:"/tickets/RJ_SRO/",RJ_TIME:"/tickets/timetickets/"}),qt=()=>{const e=$e(ve.ticket),t=i(ke,e=>e.state[ve.ticket]),[a,n]=r();return R({fetchTickets:async(t,a)=>{if(e(void 0,!0),!t.length)return n(void 0),e(void 0,!1),!0;const r={RJ_SEAT:[],RJ_TIME:[],RJ_SRO:[],FLEXI:[]};t.forEach((e,t)=>r[e.type].push(t));try{const o=(await Promise.all(t.map(({id:e,type:t})=>D.get(Wt[t]+e,{signal:a,headers:"RJ_SEAT"===t?{Accept:"application/1.3.0+json"}:void 0})))).map(e=>e.data),s={RJ_SEAT:o.filter((e,t)=>r.RJ_SEAT.includes(t)),RJ_TIME:o.filter((e,t)=>r.RJ_TIME.includes(t)),RJ_SRO:o.filter((e,t)=>r.RJ_SRO.includes(t))};return W({event:"BOUGHT_TICKETS",BOUGHT_TICKETS:s}),n(s),e(void 0,!1),!0}catch(t){var o;return e(g(t)?(null==(o=t.response)?void 0:o.data.message)||$(t):F,!1),!1}},tickets:a},t)},Vt={"X-Application-Origin":"WEB"},Qt=({code:e,number:a,timeTableId:r},n)=>{const[{error:o,loading:s,data:i=[]}]=De({url:`/consts/timetables/${e}/${a}`,method:"GET",headers:Vt}),[{data:l=[]},c]=we({url:`/consts/timetables/${r}/symbols`,method:"GET",headers:Vt}),[{data:d=[]},u]=we({url:`/consts/timetables/${r}/time-codes`,method:"GET",headers:Vt});return t(()=>{if(!n)return;const e=new AbortController,t=e.signal;return c({signal:t}),u({signal:t}),()=>{e.abort()}},[n]),{error:o,loading:s,data:i,symbols:l,timeCodes:d}},Zt=e=>{const{getStation:t}=je(),[{error:a,loading:r,data:n}]=De({url:`/consts/timetables/${e}`,method:"GET"});return{error:a,loading:r,stations:((null==n?void 0:n.stations)||[]).map(e=>R({},e,t(e.stationId))),fromCityName:null==n?void 0:n.fromCityName,toCityName:null==n?void 0:n.toCityName,carrierId:null==n?void 0:n.carrierId}},ea=()=>{const e=$e(ve.seatClasses),a=i(ke,e=>e.state[ve.seatClasses]),{error:r,loading:n}=i(Le,e=>e.seatClassesResponse),o=i(Le,e=>e.seatClasses),s=null==o?void 0:o.reduce((e,t)=>(e[t.key]=t,e),{});return t(()=>{var t;e(null==r||null==(t=r.response)?void 0:t.data.message,!!n)},[e,r,n]),R({data:s},a)};let ta,aa;const ra=()=>{const e=i(Pe,e=>e.dispatch.upsellDispatch),t=i(Pe,e=>e.state.upsell.cooldownTs);return{acceptUpsell:()=>W({event:"ACCEPT_UPSELL",ACCEPT_UPSELL:{acceptedClass:ta,priceDiff:aa,currency:D.defaults.headers.common["X-Currency"]}}),refuseUpsell:()=>e({type:"REFUSE_UPSELL"}),shouldShowUpsell:(a,r,n)=>{var o;e({type:"REFRESH_COOLDOWN"});const s=z(a,r);if(!s||t>(new Date).valueOf()||"RJ_SEAT"!==n)return null;const i=s.price-((null==(o=r.find(e=>e.seatClassKey===a))?void 0:o.price)||0);return ta=s.seatClassKey,aa=i,{priceDiff:i,upsellClass:s}}}},na=()=>{const e=$e(ve.vehicleStandards),a=i(ke,e=>e.state[ve.vehicleStandards]),{error:r,loading:n}=i(Le,e=>e.vehicleStandardsResponse),o=i(Le,e=>e.vehicleStandards),s=null==o?void 0:o.reduce((e,t)=>(e[t.key]=t,e),{});return t(()=>{var t;e(null==r||null==(t=r.response)||null==(t=t.data)?void 0:t.message,!!n)},[e,r,n]),R({data:s},a)};export{Se as BookingContext,Le as PersistContext,ke as ResponseStateContext,Be as ShopReduxProvider,Pe as StoreContext,Y as consts,Ct as emptyTickets,O as types,Ge as useAddons,De as useApi,He as useBookingActions,Ye as useBookingDiscount,Xe as useBookingPrice,ct as useCityPairs,Ze as useConnection,gt as useConnectionRoute,Mt as useCreateTickets,it as useCredit,lt as useDepartures,mt as useFlexiTickets,vt as useHeaders,Rt as useHeadersActions,Qt as useLineTimetables,Jt as useLines,je as useLocations,we as useManualApi,st as usePassengersData,Lt as usePayment,Yt as usePaymentsHistory,Gt as useSearchLocations,ea as useSeatClasses,Ht as useSeats,$e as useSetResponseState,Xt as useTariffs,jt as useTicketActions,zt as useTicketReview,qt as useTickets,yt as useTimeTickets,Zt as useTimetables,ra as useUpsell,kt as useUser,At as useUserActions,Nt as useUserTickets,na as useVehicleStandards,ae as utils};
//# sourceMappingURL=index.modern.mjs.map
